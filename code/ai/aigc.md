# 大模型系列-数据处理之向量数据库



大模型业务流程

![image-20241121221535217](images/大模型业务流程.png)



![image-20241121221535217](images/向量数据库思维导图.png)



```text
思考：
向量数据库Vector-DB对大模型的价值和意义是什么？
向量数据库Vector-DB会不会随看大模型能力的提升而被代替？
围绕着大模型配套软件开发工具，向量数据库处于什么样的角色定位？
```



## 背景

>  互联网非结构化数据以惊人速度增长，比如文档、图像、视频和普通文本等形式。 传统数据库针对结构化数据建立，处理非结构化数据变得越来越困难。

> 仅通过关键词分析、 数据分类不足以完全表示挖掘和学习复杂数据所蕴含知识，特别在AI一切皆`Embedding Vector`时代。

![image-20241121223213197](images/image-20241121223213197.png)



```text
AI与Vector的关系：
移动互联网JSON支撑大规模灵活数据存储的通用格式，推动MongoDB流行。
AI时代向量Vector作为神经网络基本数据结构，Vector也是大模型理解世界数据形式。
```

![image-20241121223519867](images/image-20241121223519867.png)



神经网络的基本组成

基于数据流图（DAG）的计算框架。

```text
基本数据结构：Tensor张量
Tensor形状：[2, 3, 45]
元素类型：int, float, string, ...

基本运算单元：Operator算子
由最基本的代数算子组成
根据深度学习结构组成复杂算子
N个输入Tensor，M个输出Tensor
```

参考：

https://github.com/chenzomi12/AISystem/blob/main/05Framework/03DataFlow/02Computegraph.md

https://github.com/chenzomi12/AISystem

https://github.com/chenzomi12/AISystem/blob/main/images/knowledge_list.png



`向量检索的核心在于相似性搜索（Similarity Search），在深入了解相似性搜索前，需要详细了解特征Feature和向量Vector的概念和原理`





## 向量与检索

### 向量Vector

什么是向量Vector?

> AI神经网络模型设计，在神经元激活后形成对输入数据表征，即人脑理解和学习的方式。
> AI模型实际识别和理解非具体文字符号，而是神经网络对各类数据向量化Vector表示。

```
向量是什么？
向量是多维数学空间中的一个坐标点。

向量从哪来？
向量来源于对世界数字化的抽象。

向量怎么用？
向量用来搜索真实世界不同模态数据。
```

![image-20241121225024081](images/image-20241121225024081.png)



向量类型（Vector type）

| 向量类型 | 详细介绍                                                     |
| -------- | ------------------------------------------------------------ |
| 图像向量 | 通过神经网络模型提取图像特征向量Feature Map，特征向量Feature Map提取输入图像的高维信息，如颜色、形状、纹理等，最终可以用于图像识别、检索等任务。 |
| 文本向量 | 通过词嵌入Work Embedding技术如`Word2vec`、`BERT`等生成文本特征向量，文本特征向量包含文本语义高维信息，可以用于文本分类、 情感分析等`NLP`任务。 |
| 语音向量 | 通过声学模型`Acoustic Model`从音频信号中提取的音频的频谱特征向量，频谱特征向量提取声音的高维特性，如音调、节奏、音色等，可用于语音识别、 声纹识别等任务。 |


 

### Embedding

什么是Embedding？

```
Embedding过程：
非结构化数据转换成向量的过程。

Embedding作用：
通过深度学习的训练，将真实世界离散数据，投影到高维数据空间上，通过数据在空间中间的距离体现真实世界的相似度。
```

![image-20241121230036273](images/image-20241121230036273.png)



### Vector Embedding

```
1、Vector Embedding：向量嵌入
将非数值词语/符号等非结构化数据，编码成数值向量。

2、Word Embedding：词嵌入
通过NN来学习，文本中词语作为NN网络输入，输出对应词向量Word Vector。
词向量是一个数值向量，每个数值代表词语的某个特征。
```

![image-20241121230431343](images/image-20241121230431343.png)

举个例子：

如何区分猫的种类？

人类通过不同事物间不同特征来识别种类，比如分辨不同种类小猫，可以通过体型大小、毛发长度、鼻子长短、 脸型等特征区分。
比如不同种类猫的体型大小，映射到一维度坐标轴上，就会得到一个体型特征与一维坐标的数值。

![image-20241121230925955](images/image-20241121230925955.png)



单靠体型特征并不能充分区分不同种类的猫咪，比如金渐层、银渐层的体型接近，难以通过体型直接区分。因此会增加其它特征，例如毛发颜色。

![image-20241121231336615](images/image-20241121231336615.png)



只要特征维度足够多，就能将所有猫区分开来，最后得到一个高维坐标系。

虽然难以想象高维坐标系，但是在向量数组中，只需要向数组中追加数值即可。



重点

`向量维度不是越高越好。维度越高，特征展开就越散，向量维度越低，嵌入空间Embedding Space中特征表示就越紧凑，应该有个合理的区间值。维度大小会影响下游任务或模型训练质量。`



https://chenzomi12.github.io/



总结

```
向量是AI理解世界的通用数据形式：
无论游戏、网络、教育、医疗等，各行业领域中使用AI能力和场景越来越多。
AI框架基本组成为向量+算子，训练和推理时可以看做向量搜索/索引和向量计算过程。

因此可认为：
向量是AI理解世界的通用数据形式，未来向量将会成为AI的灵魂。
```



## 向量数据库

将向量存到数据库，便于后续语义搜索。

### 与传统数据库区别

```
与传统数据库区别：
传统数据库：
1、关系型数据库
2、非关系型NoSQL数据库
3、分析型数据库

搜索方式：
索引（B-Tree、 倒排等）
排序算法（BM25、 TF-IDF）实现

搜索本质：
基于文本的精确匹配，SQL语言进行精确匹配与查找，输出符合查询条件数据

适合场景：
关键字搜索功能较优，对于语义搜索功能较差
```

```
问题：
传统数据库无法识别语义关系，需要打上标签进行关联，才能实现语义搜索
```

```
差异1：检索方式不同
传统数据库：归结为点查和范围查（精确查找），查询得到结果为符合条件/不符合条件
向量数据库：针对向量近似查找，查询得到结果是与输入条件相似 TOP-K向量

差异2：查询方式不同
传统数据库：直接处理数据，即使用SQL语言对文本精确匹配与查找，输出符合查询条件数据
向量数据库：将非结构化数据转化为向量，再基于向量数据库中进行存储、计算和建立索引
```

```
Pinecone：
https://colab.research.google.com/github/pinecone-io/examples/blob/master/docs/semantic-search.ipynb#scrollTo=JWcO7jAK-N_I

MySQL：
https://dey.mysql.com/docfconnector-python/en/connector-python-example-cursor-select.html
```

![image-20241122002822949](images/image-20241122002822949.png)



`semantic-search.ipynb`



### 向量数据库原理、功能、 特点

随着互联网发展，非结构化数据越来越常见。 为了让计算机理解和处理非结构化的数据，Embedding将各式数据转换为Vector数据。

通过向量数据库存储和索引Vector数据，分析Vector间相关性。



用户输入查询（NLP、 Image、 Audio）被转换成Vector，与源数据本身位于相同 Embedding空间中，Vector通过向量数据进行语义近似搜索，返回与输入查询最相似TOP-K个结果。

![image-20241122003415043](images/image-20241122003415043.png)



**Vector DB定义**

`向量数据库为向量数据提供专用的存储和索引机制。`
向量数据被存储为高维空间中的点，DB为点建立索引（KD-Tree、 BB-Tree、 HNSW等）。

索引结构使得Vector DB高效地进行向量间相似度查询，从而提升处理向量数据效率。

![image-20241122003713006](images/image-20241122003713006.png)

**Vector DB发展**

```
第一阶段（初级）
主要是以文件形式存储向量数据，缺之有效索引和查询能力，典型产品如Lucene等。

第二阶段（发展阶段）
使用KD树等索引结构，可实现一定的查询性能，但在高维空间的查询效率还不高，典型产品有FAISS、Annoy等。

第三阶段（成熟阶段）
通过复杂Index算法实现高效向量索引和查询，处理高维向量数据，典型产品有Milvus、 Elasticsearch等。
```

![image-20241122004131086](images/image-20241122004131086.png)



Vector DB存储向量类型

```
1、私域知识 Domain Knowledge
私域知识是指可以把向量数据库作为大模型的外部知识库。不需要去训练模型，比常见的大模型微调地方法成本更低、速度更快也能通过更新数据库保证AI大模型知识的实时更新。

2、本地存储 Local Storage
将向量数据存储在本地。通过向量的相似关系保证隐私信息不会提供给大模型进行训练。

3、长期记忆 Long Time Memory
长期记忆是相比大模型的短期记忆，大模型如ChatGPT其上下文信息有数量限制。Vector DB作为外部数据库，存储单次上传的超大文本、对话内容等信息，为大模型提供理论上没有上限的长期记忆。
```

**Vector DB解决的问题**

```
主要解决2个问题：高效的检索与高效的分析

1、检索：以图搜图场景，比如人脸检索、人脸支付、车牌号码检索、相似商品检索等
2、分析：以图分析行为，比如人脸撞库、人脸对比、场景再现等
```

**作用1：相似性搜索**

允许根据向量距离或相似性对向量数据Vector进行快速准确的相似性搜索和检索。 

这意味着可以使用Vector DB，根据语义或上下文含义查找最相似或相关的数据，而非精确匹配或预定义标准查询数据库的传统方法。

![image-20241122003415043](images/image-20241122003415043.png)

**作用2：提升性能**
针对大量向量数据Vector存储和检索操作进行优化，每次查询通常处理数亿个向量，并且比传统数据库的处理速度快得多。

以下主要介绍向量数据库最核心的几种技术和能力：
1、相似度计算：使用相似性度量等算法过滤和定位相似的向量

2、相似性搜索：提供Vector检索算法，使向量检索速度显著加快并更精确

3、高效存储：以更紧方式存储向量，如压缩和量化向量数据，尽可能在内存中查询数据

4、分布式：跨多台机器对向量数据进行分片和分片检索



**向量数据库常用评价标准**

```
1、准确率 Precision
准确率 = 检索相关的向量/检索出的向量总数

2、召回率 Recall
召回率 = 检索相关的向量/向量数据库中相关的向量总数

3、每秒平均吞吐 QPS
Query Per Second，QPS是每秒查询数，每秒向量数据库能够处理的查询请求次数

4、平均响应延识 Latency
可量数据库的请求平均响应时间
```

**向量数据库总结**

| 功能                       | 描述                                                         |
| -------------------------- | ------------------------------------------------------------ |
| Vector Embedding  向量嵌入 | 数学上，vector embedding是一个浮点数或二进制数的数组，通过对非结构化数据转换为具体的vector（对非结构化数据的特征抽象）。Vector DB提供数据写入/检索自动向量化，对齐传统数据库的使用体验，用户无需关注向量生成过程。 |
| Similar Search 相似性搜索  | 使用Index算法和特殊数据结构对Embedding进行相似性搜索。用户可以快速找到与给定查询最接近的vector，因此适合对图像或文相似性搜索。其中向量相似度搜索是将输入Vector与数据库进行比较，以找到与查询向量最相以的向量过程 |
| High Performance 提升性能  | Vector DB单索引支持 > 亿级向量数据规模，可支持百万级QPS及毫秒级查询延退。另外对高维向量的高效存储，能够在最小存储空间下处理更大量数据。 |
| 可扩展                     | 具备良好的可扩展性，能够轻松处理大规模数据集，支持对Vector数据进行分片，良好支持广泛依赖嵌入的大语言模型和其他AI应用。 |
| 灵活性                     | 能够处理不同数据（非机构化数据）类型，这些信息不遵循预定义的模型或组织方式，包括文本、图像、音频和视频。 |

**向量数据库面临的挑战**

```
1、有效存储：
向量数据多为浮点或者二进制数据，数据压缩率低，存储成本高。（向量维度高，稀疏矩阵）
2、高效存储：
向量数据库计算复杂度高，需要集群&分布式计算能力。
3、索引复杂：
有tree、graph、hash等多种向量索引方式，索引管理和使用成本高。
4、扩展性：
向量数据库的增长对系统的扩展性要求越来越高。
5、低延退：
查询以ms级别响应业务需求。
```



### `Vector-DB`应用场景



## 大模型关系

向量数据库遇到大模型

大模型与`Vector-DB`应用场景

## 相似性搜索

`K-Means聚类`

`Faiss算法`

`PQ算法`

`IVF算法`

`HNSW算法`

## 相似性度量

`欧氏距离（L2）`

`内积（IP）`

`其他度量方式`



## 通用性架构

通用`Vector-DB`架构

`KDB架构示例`



## 业界向量数据库横向对比

Vector-DB小结



